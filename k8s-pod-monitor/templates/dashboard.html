<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kubernetes Pod Monitor</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"><script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script><style>body{background-color:#f8f9fa}.card{box-shadow:0 2px 4px #0000001a}.table-hover tbody tr:hover{cursor:pointer}#loading-spinner{position:fixed;top:50%;left:50%;z-index:1050;transform:translate(-50%,-50%)}.modal-body .event-item{border-bottom:1px solid #dee2e6;padding-bottom:.5rem;margin-bottom:.5rem}.modal-body .event-item:last-child{border-bottom:0}</style></head><body><div id="loading-spinner" class="spinner-border text-primary" role="status" style="display:none"></div><div class="container-fluid mt-4"><div class="d-flex justify-content-between align-items-center mb-4"><h1 class="h3">üìä Kubernetes Pod Monitor (Excel Export)</h1><div><a href="/api/download/excel" class="btn btn-success">üíæ Download Excel</a><button id="force-refresh-btn" class="btn btn-primary ms-2">üîÑ Force Refresh</button></div></div><div class="row mb-3"><div class="col"><small class="text-muted">Last Updated: <span id="last-updated">N/A</span> | Background Status: <span id="background-status">N/A</span></small></div></div><div class="row mb-4"><div class="col-lg-3 col-md-6 mb-3"><div class="card text-center h-100"><div class="card-body"><h5 class="card-title">üö® Total Abnormal Pods</h5><p id="stat-total" class="card-text text-danger fs-1 fw-bold">0</p></div></div></div><div class="col-lg-3 col-md-6 mb-3"><div class="card text-center h-100"><div class="card-body"><h5 class="card-title">‚ú® New Issues (Today)</h5><p id="stat-new" class="card-text text-warning fs-1 fw-bold">0</p></div></div></div><div class="col-lg-3 col-md-6 mb-3"><div class="card text-center h-100"><div class="card-body"><h5 class="card-title">‚è≥ Ongoing Issues</h5><p id="stat-ongoing" class="card-text text-info fs-1 fw-bold">0</p></div></div></div><div class="col-lg-3 col-md-6 mb-3"><div class="card text-center h-100"><div class="card-body"><h5 class="card-title">‚úÖ Resolved Issues</h5><p id="stat-resolved" class="card-text text-success fs-1 fw-bold">0</p></div></div></div></div><div class="row mb-4"><div class="col-lg-6 mb-3"><div class="card h-100"><div class="card-header">Status Distribution</div><div class="card-body"><div id="chart-status-distribution"></div></div></div></div><div class="col-lg-6 mb-3"><div class="card h-100"><div class="card-header">Abnormal Pods by Cluster</div><div class="card-body"><div id="chart-cluster-distribution"></div></div></div></div></div><div class="card"><div class="card-header"><ul class="nav nav-tabs card-header-tabs" id="pod-tabs"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-new">New <span id="badge-new" class="badge bg-warning"></span></a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-ongoing">Ongoing <span id="badge-ongoing" class="badge bg-info"></span></a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-resolved">Resolved <span id="badge-resolved" class="badge bg-success"></span></a></li></ul></div><div class="card-body"><div class="tab-content"><div class="tab-pane fade show active" id="tab-new"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Cluster</th><th>Namespace</th><th>Pod</th><th>Node</th><th>Status</th><th>Reasons</th></tr></thead><tbody id="table-body-new"></tbody></table></div></div><div class="tab-pane fade" id="tab-ongoing"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Cluster</th><th>Namespace</th><th>Pod</th><th>Node</th><th>Status</th><th>Reasons</th></tr></thead><tbody id="table-body-ongoing"></tbody></table></div></div><div class="tab-pane fade" id="tab-resolved"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Cluster</th><th>Namespace</th><th>Pod</th><th>Node</th><th>Status</th><th>Reasons</th></tr></thead><tbody id="table-body-resolved"></tbody></table></div></div></div></div></div></div><div class="modal fade" id="eventModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="eventModalLabel">Pod Events</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="eventModalBody"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script><script>
    const G={API_URL:"/api/data",REFRESH_URL:"/api/run-check",EVENTS_URL:"/api/pod/events",spinner:document.getElementById("loading-spinner"),modal:null};function showSpinner(){G.spinner.style.display="block"}function hideSpinner(){G.spinner.style.display="none"}
    function createTableRow(p){const statusBadgeColor=p.status==="Running"?"bg-warning":"bg-danger";return`<tr onclick="showPodEvents('${p.context_name}','${p.namespace}','${p.pod}')"><td><b>${p.cluster||"N/A"}</b></td><td>${p.namespace||"N/A"}</td><td>${p.pod||"N/A"}</td><td>${p.node||"N/A"}</td><td><span class="badge ${statusBadgeColor}">${p.status||"N/A"}</span></td><td>${p.reasons||"N/A"}</td></tr>`}
    async function showPodEvents(context,namespace,pod){if(!G.modal)G.modal=new bootstrap.Modal(document.getElementById("eventModal"));const modalTitle=document.getElementById("eventModalLabel"),modalBody=document.getElementById("eventModalBody");modalTitle.textContent=`Events for: ${namespace}/${pod}`;modalBody.innerHTML='<div class="text-center"><div class="spinner-border"></div></div>';G.modal.show();try{const url=`${G.EVENTS_URL}?context=${encodeURIComponent(context)}&namespace=${encodeURIComponent(namespace)}&pod=${encodeURIComponent(pod)}`,response=await fetch(url);if(!response.ok)throw new Error(`Network response was not ok: ${response.statusText}`);const events=await response.json();if(events.length===0){modalBody.innerHTML='<p class="text-muted">No events found for this pod.</p>';return}
    let eventsHtml=events.map(e=>{const typeClass=e.type==="Warning"?"text-danger":"text-muted",time=e.last_seen?new Date(e.last_seen).toLocaleString():"N/A";return`<div class="event-item"><p class="mb-1"><strong>${e.reason||"N/A"}</strong> <span class="${typeClass}">(${e.type||"N/A"})</span></p><p class="mb-1 small">${e.message||""}</p><p class="mb-0 text-muted small">Last Seen: ${time}</p></div>`}).join("");modalBody.innerHTML=eventsHtml}catch(error){console.error("Failed to fetch pod events:",error);modalBody.innerHTML=`<div class="alert alert-danger">Failed to load events. ${error.message}</div>`}}
    function updateUI(data){for(const key of["total","new","ongoing","resolved"]){document.getElementById(`stat-${key}`).textContent=data.stats[key];if(key!=="total")document.getElementById(`badge-${key}`).textContent=data.stats[key]}
    for(const key of["new","ongoing","resolved"])document.getElementById(`table-body-${key}`).innerHTML=data.lists[key].map(createTableRow).join("");const chartLayout={margin:{l:40,r:20,t:40,b:20},height:300};Plotly.newPlot("chart-status-distribution",[{labels:data.charts.status_distribution.labels,values:data.charts.status_distribution.values,type:"pie",hole:.4}],chartLayout,{responsive:!0,displaylogo:!1});Plotly.newPlot("chart-cluster-distribution",[{x:data.charts.cluster_distribution.labels,y:data.charts.cluster_distribution.values,type:"bar",marker:{color:"#0d6efd"}}],chartLayout,{responsive:!0,displaylogo:!1});document.getElementById("last-updated").textContent=new Date(data.last_updated).toLocaleString();if(data.background_status)document.getElementById("background-status").textContent=`${data.background_status.last_run} (${data.background_status.last_result})`}
    async function fetchData(){try{const response=await fetch(G.API_URL);if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);updateUI(await response.json())}catch(error){console.error("Failed to fetch data:",error);alert("Failed to load dashboard data. Check server logs.")}}
    async function forceRefresh(){showSpinner();document.getElementById("force-refresh-btn").disabled=!0;try{const response=await fetch(G.REFRESH_URL,{method:"POST"}),result=await response.json();if(!response.ok)throw new Error(result.message||"Failed to start refresh.");alert(result.message);setTimeout(()=>fetchData().finally(()=>{hideSpinner();document.getElementById("force-refresh-btn").disabled=!1}),3e3)}catch(error){console.error("Failed to force refresh:",error);alert(`Error: ${error.message}`);hideSpinner();document.getElementById("force-refresh-btn").disabled=!1}}
    document.addEventListener("DOMContentLoaded",()=>{showSpinner();fetchData().finally(hideSpinner);setInterval(fetchData,6e4);document.getElementById("force-refresh-btn").addEventListener("click",forceRefresh)});
    </script></body></html>
